version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: duplicate-guard-db-prod
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:5000/api/health > /dev/null || exit 1" ]
      interval: 10s
      retries: 5
      timeout: 5s
      start_period: 10s
    networks:
      - duplicate-guard-network

  # BLUE version (active)
  app_blue:
    image: ghcr.io/impara/orderauditor:latest
    container_name: duplicate-guard-app-blue
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      DB_POOL_MAX: ${DB_POOL_MAX:-20}
      DB_POOL_MIN: ${DB_POOL_MIN:-5}
      SHOPIFY_SHOP_DOMAIN: ${SHOPIFY_SHOP_DOMAIN}
      SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SHOPIFY_API_SECRET: ${SHOPIFY_API_SECRET}
      SHOPIFY_WEBHOOK_SECRET: ${SHOPIFY_WEBHOOK_SECRET:-}
      SHOPIFY_BILLING_TEST_MODE: ${SHOPIFY_BILLING_TEST_MODE:-true}
      APP_URL: ${APP_URL}
      VITE_SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM:-${SMTP_USER}}
      TZ: ${TZ:-UTC}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports:
      - "5000:5000" # host -> container
    depends_on:
      - postgres
    networks:
      - duplicate-guard-network
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:5000/health', r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # GREEN version (inactive)
  app_green:
    image: ghcr.io/impara/orderauditor:latest
    container_name: duplicate-guard-app-green
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      DB_POOL_MAX: ${DB_POOL_MAX:-20}
      DB_POOL_MIN: ${DB_POOL_MIN:-5}
      SHOPIFY_SHOP_DOMAIN: ${SHOPIFY_SHOP_DOMAIN}
      SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SHOPIFY_API_SECRET: ${SHOPIFY_API_SECRET}
      SHOPIFY_WEBHOOK_SECRET: ${SHOPIFY_WEBHOOK_SECRET:-}
      SHOPIFY_BILLING_TEST_MODE: ${SHOPIFY_BILLING_TEST_MODE:-true}
      APP_URL: ${APP_URL}
      VITE_SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM:-${SMTP_USER}}
      TZ: ${TZ:-UTC}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports: [] # inactive until promoted
    depends_on:
      - postgres
    networks:
      - duplicate-guard-network
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:5000/health', r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  postgres_data_prod:


networks:
  duplicate-guard-network:
    driver: bridge
