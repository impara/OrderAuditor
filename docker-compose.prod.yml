version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: duplicate-guard-db-prod
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - duplicate-guard-network

  app:
    # Example: ghcr.io/myusername/orderauditor:latest
    image: ghcr.io/impara/orderauditor:latest
    container_name: duplicate-guard-app-prod
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: ${PORT:-5000}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      SHOPIFY_SHOP_DOMAIN: ${SHOPIFY_SHOP_DOMAIN}
      SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SHOPIFY_API_SECRET: ${SHOPIFY_API_SECRET}
      # SHOPIFY_WEBHOOK_SECRET is legacy (for custom apps only) - not needed for Partner Apps
      # For Partner Apps, webhook verification uses SHOPIFY_API_SECRET
      SHOPIFY_WEBHOOK_SECRET: ${SHOPIFY_WEBHOOK_SECRET:-}
      APP_URL: ${APP_URL}
      VITE_SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM:-${SMTP_USER}}
      TZ: ${TZ:-UTC}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports:
      - "${PORT:-5000}:5000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:5000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - duplicate-guard-network

  # Ofelia - Cron-like job scheduler for Docker
  # Runs periodic maintenance tasks (webhook cleanup, etc.)
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: duplicate-guard-scheduler
    restart: unless-stopped
    depends_on:
      - app
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      # Run cleanup job daily at 3 AM
      ofelia.job-exec.cleanup-webhooks.schedule: "0 0 3 * * *"
      ofelia.job-exec.cleanup-webhooks.container: "duplicate-guard-app-prod"
      ofelia.job-exec.cleanup-webhooks.command: >
        node -e "fetch('http://localhost:5000/api/internal/cleanup', {method: 'POST'}) .then(r => r.json()) .then(d => console.log('Cleanup result:', d)) .catch(e => console.error('Cleanup failed:', e))"
    networks:
      - duplicate-guard-network

volumes:
  postgres_data_prod:


networks:
  duplicate-guard-network:
    driver: bridge
